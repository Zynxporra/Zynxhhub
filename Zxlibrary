if not getgenv().gethui then
    getgenv().gethui = function() return game:GetService("CoreGui") end
end

local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")

local OrionLib = {
    Elements = {},
    Flags = {},
    Connections = {},
    Themes = {
        SleekRed = {
            Main = Color3.fromRGB(10, 10, 10),
            Second = Color3.fromRGB(18, 18, 18),
            Stroke = Color3.fromRGB(255, 45, 45),
            Divider = Color3.fromRGB(200, 40, 40),
            Text = Color3.fromRGB(255, 255, 255),
            TextDark = Color3.fromRGB(180, 180, 180)
        }
    },
    SelectedTheme = "SleekRed",
    SaveCfg = false,
    Folder = nil
}

local function styleFrame(f, corner)
    local c = Instance.new("UICorner")
    c.CornerRadius = UDim.new(0, corner or 12)
    c.Parent = f
    local s = Instance.new("UIStroke")
    s.Thickness = 2
    s.Color = OrionLib.Themes[OrionLib.SelectedTheme].Stroke
    s.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    s.Parent = f
end

local function styleButton(b, corner)
    local c = Instance.new("UICorner")
    c.CornerRadius = UDim.new(0, corner or 10)
    c.Parent = b
end

local function makeText(parent, text, size, color, bold, align)
    local t = Instance.new("TextLabel")
    t.BackgroundTransparency = 1
    t.Text = text or ""
    t.Font = bold and Enum.Font.GothamBold or Enum.Font.Gotham
    t.TextSize = size or 14
    t.TextColor3 = color or OrionLib.Themes[OrionLib.SelectedTheme].Text
    t.TextXAlignment = align or Enum.TextXAlignment.Left
    t.Parent = parent
    return t
end

local function makeIcon(parent, assetId)
    local img = Instance.new("ImageLabel")
    img.BackgroundTransparency = 1
    img.Size = UDim2.new(0, 20, 0, 20)
    img.Image = assetId or ""
    img.Parent = parent
    return img
end

local function draggable(header, root)
    local dragging, dragInput, mousePos, framePos = false, nil, nil, nil
    header.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            mousePos = input.Position
            framePos = root.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    header.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - mousePos
            root.Position = UDim2.new(framePos.X.Scale, framePos.X.Offset + delta.X, framePos.Y.Scale, framePos.Y.Offset + delta.Y)
        end
    end)
end

function OrionLib:MakeWindow(opts)
    local theme = OrionLib.Themes[OrionLib.SelectedTheme]
    local gui = Instance.new("ScreenGui")
    gui.Name = "Orion"
    if syn then syn.protect_gui(gui) end
    gui.Parent = gethui() or game:GetService("CoreGui")

    local root = Instance.new("Frame")
    root.BackgroundColor3 = theme.Main
    root.Size = UDim2.new(0, 620, 0, 420)
    root.Position = UDim2.new(0.5, -310, 0.5, -210)
    root.Parent = gui
    styleFrame(root, 14)

    local header = Instance.new("Frame")
    header.BackgroundColor3 = theme.Second
    header.Size = UDim2.new(1, -16, 0, 48)
    header.Position = UDim2.new(0, 8, 0, 8)
    header.Parent = root
    styleFrame(header, 12)

    local title = makeText(header, (opts and opts.Name) or "Orion", 16, theme.Text, true)
    title.Position = UDim2.new(0, 14, 0, 14)
    title.Size = UDim2.new(1, -120, 0, 20)

    if opts and opts.Icon then
        local ic = makeIcon(header, opts.Icon)
        ic.Position = UDim2.new(0, 90, 0, 14)
    end

    local close = Instance.new("TextButton")
    close.BackgroundColor3 = theme.Second
    close.Size = UDim2.new(0, 36, 0, 30)
    close.Position = UDim2.new(1, -44, 0, 9)
    close.Text = "Ã—"
    close.TextColor3 = theme.Text
    close.TextSize = 20
    close.Font = Enum.Font.GothamBold
    close.Parent = header
    styleButton(close, 8)
    close.MouseButton1Click:Connect(function()
        if opts and opts.CloseCallback then opts.CloseCallback() end
        gui:Destroy()
    end)

    draggable(header, root)

    local sidebar = Instance.new("Frame")
    sidebar.BackgroundColor3 = theme.Second
    sidebar.Size = UDim2.new(0, 180, 1, -72)
    sidebar.Position = UDim2.new(0, 8, 0, 64)
    sidebar.Parent = root
    styleFrame(sidebar, 12)

    local tabList = Instance.new("ScrollingFrame")
    tabList.BackgroundTransparency = 1
    tabList.Size = UDim2.new(1, -10, 1, -10)
    tabList.Position = UDim2.new(0, 5, 0, 5)
    tabList.CanvasSize = UDim2.new(0,0,0,0)
    tabList.ScrollBarThickness = 6
    tabList.Parent = sidebar
    local tabLayout = Instance.new("UIListLayout")
    tabLayout.Padding = UDim.new(0, 8)
    tabLayout.Parent = tabList

    local content = Instance.new("Frame")
    content.BackgroundColor3 = theme.Second
    content.Size = UDim2.new(1, -196, 1, -72)
    content.Position = UDim2.new(0, 188, 0, 64)
    content.Parent = root
    styleFrame(content, 12)

    local pages = Instance.new("Folder")
    pages.Name = "Pages"
    pages.Parent = content

    local window = {}

    function window:MakeTab(topts)
        local btn = Instance.new("TextButton")
        btn.BackgroundColor3 = theme.Main
        btn.Size = UDim2.new(1, -10, 0, 38)
        btn.Text = topts and topts.Name or "Tab"
        btn.TextColor3 = theme.Text
        btn.TextSize = 14
        btn.Font = Enum.Font.GothamSemibold
        btn.Parent = tabList
        styleButton(btn, 10)

        local page = Instance.new("Frame")
        page.BackgroundTransparency = 1
        page.Size = UDim2.new(1, -10, 1, -10)
        page.Position = UDim2.new(0, 5, 0, 5)
        page.Visible = false
        page.Parent = pages

        local list = Instance.new("UIListLayout")
        list.Padding = UDim.new(0, 10)
        list.Parent = page

        btn.MouseButton1Click:Connect(function()
            for _, p in ipairs(pages:GetChildren()) do p.Visible = false end
            page.Visible = true
            TweenService:Create(btn, TweenInfo.new(0.18, Enum.EasingStyle.Quint), {BackgroundColor3 = theme.Second}):Play()
        end)

        local tab = {}

        function tab:AddSection(sopts)
            local sec = Instance.new("Frame")
            sec.BackgroundColor3 = theme.Main
            sec.Size = UDim2.new(1, 0, 0, 64)
            sec.Parent = page
            styleFrame(sec, 10)
            local name = makeText(sec, (sopts and sopts.Name) or "Section", 14, theme.Text, true)
            name.Position = UDim2.new(0, 12, 0, 10)
            name.Size = UDim2.new(1, -24, 0, 20)
            local body = Instance.new("Frame")
            body.BackgroundTransparency = 1
            body.Size = UDim2.new(1, -24, 0, 26)
            body.Position = UDim2.new(0, 12, 0, 34)
            body.Parent = sec
            local bodyList = Instance.new("UIListLayout")
            bodyList.FillDirection = Enum.FillDirection.Horizontal
            bodyList.Padding = UDim.new(0, 8)
            bodyList.Parent = body
            return body
        end

        function tab:AddLabel(text)
            local holder = Instance.new("Frame")
            holder.BackgroundColor3 = theme.Main
            holder.Size = UDim2.new(1, 0, 0, 42)
            holder.Parent = page
            styleFrame(holder, 10)
            local l = makeText(holder, text or "Label", 14, theme.Text, false)
            l.Position = UDim2.new(0, 12, 0, 12)
            l.Size = UDim2.new(1, -24, 0, 18)
            return {Set=function(v) l.Text = v end}
        end

        function tab:AddParagraph(title, text)
            local holder = Instance.new("Frame")
            holder.BackgroundColor3 = theme.Main
            holder.Size = UDim2.new(1, 0, 0, 98)
            holder.Parent = page
            styleFrame(holder, 10)
            local t = makeText(holder, title or "Paragraph", 14, theme.Text, true)
            t.Position = UDim2.new(0, 12, 0, 10)
            t.Size = UDim2.new(1, -24, 0, 20)
            local b = makeText(holder, text or "", 13, theme.TextDark, false)
            b.Position = UDim2.new(0, 12, 0, 36)
            b.Size = UDim2.new(1, -24, 0, 52)
            b.TextWrapped = true
            return {Set=function(nt, nb) t.Text = nt; b.Text = nb end}
        end

        function tab:AddButton(bopts)
            local holder = Instance.new("Frame")
            holder.BackgroundColor3 = theme.Main
            holder.Size = UDim2.new(1, 0, 0, 46)
            holder.Parent = page
            styleFrame(holder, 10)
            local btn = Instance.new("TextButton")
            btn.BackgroundColor3 = theme.Second
            btn.Size = UDim2.new(0, 160, 0, 30)
            btn.Position = UDim2.new(0, 12, 0, 8)
            btn.Text = (bopts and bopts.Name) or "Button"
            btn.TextSize = 14
            btn.TextColor3 = theme.Text
            btn.Font = Enum.Font.GothamSemibold
            btn.Parent = holder
            styleButton(btn, 8)
            btn.MouseButton1Click:Connect(function()
                if bopts and bopts.Callback then bopts.Callback() end
            end)
            return btn
        end

        function tab:AddToggle(topts)
            local holder = Instance.new("Frame")
            holder.BackgroundColor3 = theme.Main
            holder.Size = UDim2.new(1, 0, 0, 46)
            holder.Parent = page
            styleFrame(holder, 10)
            local name = makeText(holder, (topts and topts.Name) or "Toggle", 14, theme.Text, false)
            name.Position = UDim2.new(0, 12, 0, 14)
            name.Size = UDim2.new(1, -120, 0, 18)
            local switch = Instance.new("Frame")
            switch.BackgroundColor3 = theme.Second
            switch.Size = UDim2.new(0, 56, 0, 28)
            switch.Position = UDim2.new(1, -72, 0, 9)
            switch.Parent = holder
            styleButton(switch, 12)
            local knob = Instance.new("Frame")
            knob.BackgroundColor3 = Color3.fromRGB(200, 200, 200)
            knob.Size = UDim2.new(0, 24, 0, 24)
            knob.Position = UDim2.new(0, 2, 0, 2)
            knob.Parent = switch
            local kc = Instance.new("UICorner") kc.CornerRadius = UDim.new(1,0) kc.Parent = knob
            local state = topts and topts.Default or false
            local function set(v)
                state = v
                local x = v and 30 or 2
                local col = v and theme.Stroke or Color3.fromRGB(200,200,200)
                TweenService:Create(knob, TweenInfo.new(0.18, Enum.EasingStyle.Quint), {Position = UDim2.new(0, x, 0, 2), BackgroundColor3 = col}):Play()
                if topts and topts.Flag then OrionLib.Flags[topts.Flag] = {Value = v} end
                if topts and topts.Callback then topts.Callback(v) end
            end
            set(state)
            switch.InputBegan:Connect(function(i) if i.UserInputType==Enum.UserInputType.MouseButton1 then set(not state) end end)
            return {Set=set}
        end

        function tab:AddSlider(sopts)
            local holder = Instance.new("Frame")
            holder.BackgroundColor3 = theme.Main
            holder.Size = UDim2.new(1, 0, 0, 66)
            holder.Parent = page
            styleFrame(holder, 10)
            local name = makeText(holder, (sopts and sopts.Name) or "Slider", 14, theme.Text, false)
            name.Position = UDim2.new(0, 12, 0, 10)
            name.Size = UDim2.new(1, -24, 0, 18)
            local bar = Instance.new("Frame")
            bar.BackgroundColor3 = theme.Second
            bar.Size = UDim2.new(1, -24, 0, 12)
            bar.Position = UDim2.new(0, 12, 0, 42)
            bar.Parent = holder
            styleButton(bar, 8)
            local fill = Instance.new("Frame")
            fill.BackgroundColor3 = sopts and sopts.Color or theme.Stroke
            fill.Size = UDim2.new(0, 0, 1, 0)
            fill.Parent = bar
            local min = (sopts and sopts.Min) or 0
            local max = (sopts and sopts.Max) or 100
            local val = (sopts and sopts.Default) or min
            local function set(v)
                val = math.clamp(v, min, max)
                local pct = (val - min) / (max - min)
                fill.Size = UDim2.new(pct, 0, 1, 0)
                if sopts and sopts.Flag then OrionLib.Flags[sopts.Flag] = {Value = val} end
                if sopts and sopts.Callback then sopts.Callback(val) end
            end
            set(val)
            bar.InputBegan:Connect(function(i)
                if i.UserInputType==Enum.UserInputType.MouseButton1 then
                    local conn
                    conn = UserInputService.InputChanged:Connect(function(m)
                        if m.UserInputType==Enum.UserInputType.MouseMovement then
                            local rel = (m.Position.X - bar.AbsolutePosition.X) / bar.AbsoluteSize.X
                            set(min + math.clamp(rel,0,1)*(max-min))
                        end
                    end)
                    UserInputService.InputEnded:Connect(function(ii)
                        if ii.UserInputType==Enum.UserInputType.MouseButton1 and conn then conn:Disconnect() end
                    end)
                end
            end)
            return {Set=set}
        end

        function tab:AddColorpicker(copts)
            local holder = Instance.new("Frame")
            holder.BackgroundColor3 = theme.Main
            holder.Size = UDim2.new(1, 0, 0, 66)
            holder.Parent = page
            styleFrame(holder, 10)
            local name = makeText(holder, (copts and copts.Name) or "Color", 14, theme.Text, false)
            name.Position = UDim2.new(0, 12, 0, 10)
            name.Size = UDim2.new(1, -24, 0, 18)
            local bar = Instance.new("Frame")
            bar.BackgroundColor3 = theme.Second
            bar.Size = UDim2.new(1, -24, 0, 12)
            bar.Position = UDim2.new(0, 12, 0, 42)
            bar.Parent = holder
            styleButton(bar, 8)
            local grad = Instance.new("UIGradient")
            grad.Color = ColorSequence.new({
                ColorSequenceKeypoint.new(0, Color3.fromHSV(0,1,1)),
                ColorSequenceKeypoint.new(0.17, Color3.fromHSV(0.17,1,1)),
                ColorSequenceKeypoint.new(0.33, Color3.fromHSV(0.33,1,1)),
                ColorSequenceKeypoint.new(0.5, Color3.fromHSV(0.5,1,1)),
                ColorSequenceKeypoint.new(0.66, Color3.fromHSV(0.66,1,1)),
                ColorSequenceKeypoint.new(0.83, Color3.fromHSV(0.83,1,1)),
                ColorSequenceKeypoint.new(1, Color3.fromHSV(1,1,1))
            })
            grad.Parent = bar
            local current = (copts and copts.Default) or Color3.fromRGB(255,0,0)
            local function send(c)
                current = c
                if copts and copts.Flag then OrionLib.Flags[copts.Flag] = {Value = c} end
                if copts and copts.Callback then copts.Callback(c) end
            end
            send(current)
            bar.InputBegan:Connect(function(i)
                if i.UserInputType==Enum.UserInputType.MouseButton1 then
                    local conn
                    conn = UserInputService.InputChanged:Connect(function(m)
                        if m.UserInputType==Enum.UserInputType.MouseMovement then
                            local rel = (m.Position.X - bar.AbsolutePosition.X) / bar.AbsoluteSize.X
                            rel = math.clamp(rel,0,1)
                            local col = Color3.fromHSV(rel,1,1)
                            send(col)
                        end
                    end)
                    UserInputService.InputEnded:Connect(function(ii)
                        if ii.UserInputType==Enum.UserInputType.MouseButton1 and conn then conn:Disconnect() end
                    end)
                end
            end)
            return {Set=function(c) send(c) end}
        end

        function tab:AddDropdown(dopts)
            local holder = Instance.new("Frame")
            holder.BackgroundColor3 = theme.Main
            holder.Size = UDim2.new(1, 0, 0, 46)
            holder.Parent = page
            styleFrame(holder, 10)
            local btn = Instance.new("TextButton")
            btn.BackgroundColor3 = theme.Second
            btn.Size = UDim2.new(1, -24, 0, 30)
            btn.Position = UDim2.new(0, 12, 0, 8)
            btn.Text = (dopts and dopts.Default) or (dopts and dopts.Name) or "Dropdown"
            btn.TextSize = 14
            btn.TextColor3 = theme.Text
            btn.Font = Enum.Font.GothamSemibold
            btn.Parent = holder
            styleButton(btn, 8)
            local list = Instance.new("Frame")
            list.BackgroundColor3 = theme.Second
            list.Size = UDim2.new(1, -24, 0, 0)
            list.Position = UDim2.new(0, 12, 0, 46)
            list.Visible = false
            list.Parent = holder
            styleFrame(list, 10)
            local l = Instance.new("UIListLayout")
            l.Padding = UDim.new(0, 6)
            l.Parent = list
            local open = false
            local function pick(o)
                btn.Text = o
                if dopts and dopts.Flag then OrionLib.Flags[dopts.Flag] = {Value = o} end
                if dopts and dopts.Callback then dopts.Callback(o) end
                open = false
                list.Visible = false
                list.Size = UDim2.new(1, -24, 0, 0)
            end
            local function populate(opts)
                for _, c in ipairs(list:GetChildren()) do if c:IsA("TextButton") then c:Destroy() end end
                for _, o in ipairs(opts or {}) do
                    local it = Instance.new("TextButton")
                    it.BackgroundColor3 = theme.Main
                    it.Size = UDim2.new(1, -10, 0, 28)
                    it.Text = o
                    it.TextColor3 = theme.Text
                    it.TextSize = 13
                    it.Font = Enum.Font.Gotham
                    it.Parent = list
                    styleButton(it, 8)
                    it.MouseButton1Click:Connect(function() pick(o) end)
                end
                list.Size = UDim2.new(1, -24, 0, #((opts or {})) * 34 + 8)
            end
            populate((dopts and dopts.Options) or {})
            btn.MouseButton1Click:Connect(function()
                open = not open
                list.Visible = open
            end)
            return {Refresh=populate, Set=function(v) btn.Text = v end}
        end

        function tab:AddTextbox(xopts)
            local holder = Instance.new("Frame")
            holder.BackgroundColor3 = theme.Main
            holder.Size = UDim2.new(1, 0, 0, 46)
            holder.Parent = page
            styleFrame(holder, 10)
            local box = Instance.new("TextBox")
            box.BackgroundColor3 = theme.Second
            box.Size = UDim2.new(1, -24, 0, 30)
            box.Position = UDim2.new(0, 12, 0, 8)
            box.Text = (xopts and xopts.Default) or ""
            box.TextColor3 = theme.Text
            box.TextSize = 14
            box.ClearTextOnFocus = xopts and xopts.TextDisappear or false
            box.Font = Enum.Font.Gotham
            box.Parent = holder
            styleButton(box, 8)
            box.FocusLost:Connect(function()
                if xopts and xopts.Flag then OrionLib.Flags[xopts.Flag] = {Value = box.Text} end
                if xopts and xopts.Callback then xopts.Callback(box.Text) end
            end)
            return {Set=function(v) box.Text = v end}
        end

        function tab:AddBind(bopts)
            local current = (bopts and bopts.Default) or Enum.KeyCode.E
            local function set(k) current = k end
            UserInputService.InputBegan:Connect(function(i, g)
                if g then return end
                if i.KeyCode == current then if bopts and bopts.Callback then bopts.Callback() end end
            end)
            return {Set=set}
        end

        return tab
    end

    function OrionLib:MakeNotification(n)
        local theme = OrionLib.Themes[OrionLib.SelectedTheme]
        local holder = Instance.new("Frame")
        holder.BackgroundColor3 = theme.Main
        holder.Size = UDim2.new(0, 280, 0, 70)
        holder.Position = UDim2.new(1, -288, 0, 64)
        holder.Parent = root
        styleFrame(holder, 10)
        local t = makeText(holder, n and n.Name or "Info", 14, theme.Text, true)
        t.Position = UDim2.new(0, 12, 0, 10)
        t.Size = UDim2.new(1, -24, 0, 20)
        local b = makeText(holder, n and n.Content or "", 13, theme.TextDark, false)
        b.Position = UDim2.new(0, 12, 0, 34)
        b.Size = UDim2.new(1, -24, 0, 28)
        b.TextWrapped = true
        local dur = (n and n.Time) or 3
        task.delay(dur, function()
            TweenService:Create(holder, TweenInfo.new(0.2, Enum.EasingStyle.Quint), {BackgroundTransparency = 1}):Play()
            task.wait(0.22)
            holder:Destroy()
        end)
    end

    function OrionLib:Init() end

    local WindowAPI = {}
    setmetatable(WindowAPI, {__index = {
        MakeTab = function(_, ...) return window:MakeTab(...) end
    }})
    return WindowAPI
end

return OrionLib
